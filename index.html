<H1> TRVEL-MIND</H1><!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="app_title">AI æ™ºæ…§æ—…éŠè¦åŠƒ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Lucide Icons (Vanilla JS version) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- å¼•å…¥ Leaflet CSS (åœ°åœ–) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- å¼•å…¥ Leaflet JS (åœ°åœ–) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8f9fa;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .page-view {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-content {
            animation: slideInUp 0.3s ease-out;
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 0.75rem;
            z-index: 0;
        }
        .leaflet-popup-content {
            font-family: 'Noto Sans TC', sans-serif;
        }
        /* Markdown æ¨£å¼å¾®èª¿ */
        .prose ul {
            list-style-type: disc;
            padding-left: 1.5em;
        }
        .prose ol {
            list-style-type: decimal;
            padding-left: 1.5em;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- å…¨åŸŸ Firebase å’Œ App è®Šæ•¸ -->
    <script>
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEFAULT_KEY", authDomain: "DEFAULT_DOMAIN", projectId: "DEFAULT_PROJECT" };
        } catch (e) {
            console.error("Firebase config parsing error:", e);
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // API Key (Gemini) - ç³»çµ±è‡ªå‹•æ³¨å…¥
        const apiKey = ""; 
    </script>

    <!-- Firebase SDK å¼•å…¥ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut as firebaseSignOut,
            setPersistence,
            browserLocalPersistence,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            collection, 
            addDoc, 
            onSnapshot,
            query,
            where,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- å…¨åŸŸè®Šæ•¸ ---
        window.app = initializeApp(firebaseConfig);
        window.db = getFirestore(window.app);
        window.auth = getAuth(window.app);
        window.currentUserId = null;
        window.currentUserEmail = null;
        window.mapInstance = null;
        window.mapMarkers = [];
        window.currentLanguage = 'zh';
        window.currentItineraryText = ""; 

        setLogLevel('Debug');

        // --- æ ¸å¿ƒ App é‚è¼¯ ---
        const authNav = document.getElementById('auth-nav');
        const userNav = document.getElementById('user-nav');
        const userEmailDisplay = document.getElementById('user-email-display');
        const quickAccess = document.getElementById('quick-access');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User is signed in:", user.uid);
                window.currentUserId = user.uid;
                window.currentUserEmail = user.email || "åŒ¿åä½¿ç”¨è€…";
                const displayName = user.displayName || user.email || "æ—…å®¢";
                
                authNav.classList.add('hidden');
                userNav.classList.remove('hidden');
                userEmailDisplay.textContent = displayName;
                loadApiKey();
                await fetchUserPreferences(user.uid);

            } else {
                console.log("User is signed out.");
                window.currentUserId = null;
                window.currentUserEmail = null;

                authNav.classList.remove('hidden');
                userNav.classList.add('hidden');
                quickAccess.classList.add('hidden');

                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Auth error:", error);
                }
            }
        });

        async function fetchUserPreferences(userId) {
            if (!userId) return;
            const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, "preferences");
            try {
                const docSnap = await getDoc(userProfileRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const frequentPlaces = data.frequentPlaces || [];
                    if (frequentPlaces.length > 0) {
                        quickAccess.innerHTML = '<h3 data-i18n="frequent_places">æ‚¨å¸¸ç€è¦½çš„åœ°å€ï¼š</h3>' +
                            frequentPlaces.map(place => 
                                `<button class="bg-white border border-blue-300 text-blue-600 px-4 py-1 rounded-full text-sm hover:bg-blue-50 ml-2 mb-2">${place}</button>`
                            ).join(' ');
                        quickAccess.classList.remove('hidden');
                        updateTranslations();
                    }
                }
            } catch (error) {
                console.error("Error fetching preferences:", error);
            }
        }

        // --- åœ°åœ–é‚è¼¯ (Leaflet) ---
        window.initMap = () => {
            if (window.mapInstance) return;
            window.mapInstance = L.map('map').setView([25.0330, 121.5654], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(window.mapInstance);
        };

        window.updateMapMarkers = (locations) => {
            if (!window.mapInstance) window.initMap();
            
            window.mapMarkers.forEach(marker => window.mapInstance.removeLayer(marker));
            window.mapMarkers = [];

            if (!locations || locations.length === 0) return;

            const bounds = L.latLngBounds();
            locations.forEach(loc => {
                if (loc.lat && loc.lng) {
                    const marker = L.marker([loc.lat, loc.lng])
                        .addTo(window.mapInstance)
                        .bindPopup(`<b class="text-blue-600">${loc.name}</b><br>${loc.desc || ''}`);
                    window.mapMarkers.push(marker);
                    bounds.extend([loc.lat, loc.lng]);
                }
            });

            if (window.mapMarkers.length > 0) {
                window.mapInstance.fitBounds(bounds, { padding: [50, 50] });
            }
        };

        // --- å°è¦½é‚è¼¯ ---
        window.showView = (viewId) => {
            document.querySelectorAll('.page-view').forEach(view => {
                view.style.display = 'none';
            });
            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.style.display = 'block';
                if (viewId === 'view-itinerary') {
                    setTimeout(() => {
                        if (window.mapInstance) window.mapInstance.invalidateSize();
                        else window.initMap();
                    }, 100);
                }
            }
            document.querySelectorAll('#main-nav button').forEach(btn => {
                btn.classList.remove('text-blue-600', 'font-semibold');
                btn.classList.add('text-gray-600');
            });
            const activeBtn = document.querySelector(`#main-nav button[data-view="${viewId}"]`);
            if (activeBtn) {
                activeBtn.classList.add('text-blue-600', 'font-semibold');
                activeBtn.classList.remove('text-gray-600');
            }
        };

        // --- å½ˆçª—é‚è¼¯ ---
        window.showModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('hidden');
        };
        window.closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('hidden');
        };
        window.showMessage = (title, message) => {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-body').textContent = message;
            showModal('message-modal');
        };

        // --- ä½¿ç”¨è€…èªè­‰ ---
        window.handleRegister = async () => {
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;
            const name = document.getElementById('reg-name').value;

            if (!email || !pass || !name) {
                showMessage("è¨»å†Šå¤±æ•—", "è«‹è¼¸å…¥æš±ç¨±ã€é›»å­éƒµä»¶å’Œå¯†ç¢¼ã€‚");
                return;
            }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;
                await updateProfile(user, { displayName: name });
                await setDoc(doc(db, `artifacts/${appId}/users/${user.uid}/profile`, "info"), {
                    email: email,
                    displayName: name,
                    createdAt: new Date()
                });
                closeModal('register-modal');
                showMessage("è¨»å†ŠæˆåŠŸ", `æ­¡è¿æ‚¨ï¼Œ${name}ï¼å·²è‡ªå‹•ç‚ºæ‚¨ç™»å…¥ã€‚`);
            } catch (error) {
                console.error("Register error:", error);
                showMessage("è¨»å†Šå¤±æ•—", error.message);
            }
        };

        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            if (!email || !pass) {
                showMessage("ç™»å…¥å¤±æ•—", "è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼ã€‚");
                return;
            }
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, email, pass);
                closeModal('login-modal');
                showMessage("ç™»å…¥æˆåŠŸ", "æ­¡è¿å›ä¾†ï¼");
            } catch (error) {
                console.error("Login error:", error);
                showMessage("ç™»å…¥å¤±æ•—", error.message);
            }
        };

        window.handleLogout = async () => {
            try {
                await firebaseSignOut(auth);
                showMessage("ç™»å‡ºæˆåŠŸ", "æ‚¨å·²ç™»å‡ºã€‚");
            } catch (error) {
                showMessage("ç™»å‡ºå¤±æ•—", error.message);
            }
        };

        // --- API Key ç®¡ç† ---
        function loadApiKey() {
            const storedKey = localStorage.getItem('user_gemini_api_key');
            if (storedKey) {
                document.getElementById('api-key-input').value = storedKey;
                document.getElementById('api-key-status').textContent = "å·²è¨­å®š";
                document.getElementById('api-key-status').classList.add('text-green-600');
            }
        }
        window.saveApiKey = () => {
            const keyInput = document.getElementById('api-key-input');
            const key = keyInput.value.trim();
            
            if (key) {
                localStorage.setItem('user_gemini_api_key', key);
                showMessage("è¨­å®šæˆåŠŸ", "API Key å·²å„²å­˜ã€‚");
                document.getElementById('api-key-status').textContent = "å·²è¨­å®š";
                document.getElementById('api-key-status').classList.remove('text-gray-500');
                document.getElementById('api-key-status').classList.add('text-green-600');
            } else {
                localStorage.removeItem('user_gemini_api_key');
                showMessage("è¨­å®šæˆåŠŸ", "å·²ç§»é™¤ä½¿ç”¨è€… API Keyï¼Œå°‡ä½¿ç”¨ç³»çµ±é è¨­ã€‚");
                document.getElementById('api-key-status').textContent = "æœªè¨­å®š (ä½¿ç”¨é è¨­)";
                document.getElementById('api-key-status').classList.remove('text-green-600');
                document.getElementById('api-key-status').classList.add('text-gray-500');
            }
            closeModal('settings-modal');
        };
        
        function getEffectiveApiKey() {
            const userKey = localStorage.getItem('user_gemini_api_key');
            return userKey || apiKey; 
        }

        // --- Gemini API æ ¸å¿ƒå‡½å¼ ---
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 || response.status >= 500) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                }
            }
        }

        async function callGeminiAPI(systemPrompt, userPrompt, imageData = null, useSearch = false, useJson = false, model = 'gemini-2.5-flash-preview-09-2025') {
            const currentKey = getEffectiveApiKey();
            
            if (!currentKey || currentKey.trim() === "") {
                showModal('settings-modal');
                throw new Error("API Key æœªè¨­å®šã€‚è«‹åœ¨å½ˆå‡ºçš„è¨­å®šè¦–çª—ä¸­è¼¸å…¥æ‚¨çš„ Gemini API Keyã€‚");
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${currentKey}`;

            // TTS Payload
            if (model === 'gemini-2.5-flash-preview-tts') {
                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                    }
                };
                return await postToGemini(apiUrl, payload);
            }

            // Standard Payload
            const userContent = { role: "user", parts: [{ text: userPrompt }] };
            if (imageData) {
                userContent.parts.push({
                    inlineData: { mimeType: imageData.mimeType, data: imageData.data }
                });
            }

            const payload = {
                contents: [userContent],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {}
            };

            if (useSearch) payload.tools = [{ "google_search": {} }];
            
            if (useJson) {
                payload.generationConfig.responseMimeType = "application/json";
                payload.generationConfig.responseSchema = {
                    type: "OBJECT",
                    properties: {
                        itineraryContent: { type: "STRING" },
                        locations: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    name: { type: "STRING" },
                                    lat: { type: "NUMBER" },
                                    lng: { type: "NUMBER" },
                                    desc: { type: "STRING" }
                                }
                            }
                        }
                    }
                };
            }

            return await postToGemini(apiUrl, payload, useJson);
        }

        async function postToGemini(apiUrl, payload, useJson = false) {
            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    
                    if (response.status === 400) {
                        showModal('settings-modal'); // Auto-open settings
                        let errorMsg = "API é‡‘é‘°ç„¡æ•ˆ";
                        try {
                            const errJson = JSON.parse(errorBody);
                            if(errJson.error && errJson.error.message) {
                                errorMsg = errJson.error.message;
                            }
                        } catch(e) {}
                        throw new Error(`é©—è­‰å¤±æ•— (${errorMsg})ã€‚è«‹æª¢æŸ¥æ‚¨çš„ API Key æ˜¯å¦æ­£ç¢ºã€‚`);
                    }
                    throw new Error(`API è«‹æ±‚å¤±æ•—: ${response.status} ${errorBody}`);
                }

                const result = await response.json();
                
                // Audio Response
                if (result.candidates?.[0]?.content?.parts?.[0]?.inlineData) {
                    return result.candidates[0].content.parts[0].inlineData;
                }

                // Text Response
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]) {
                    const text = candidate.content.parts[0].text;
                    if (useJson) return JSON.parse(text);
                    return { text };
                }
                
                throw new Error("API å›æ‡‰ç„¡æ•ˆ");
            } catch (error) {
                console.error("Gemini API error:", error);
                throw error;
            }
        }

        // --- åœ–ç‰‡è™•ç† ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = function() {
                const base64String = reader.result.replace("data:", "").replace(/^.+,/, "");
                window.uploadedImage = { data: base64String, mimeType: file.type };
                const preview = document.getElementById('image-preview');
                preview.innerHTML = `<img src="${reader.result}" class="h-32 rounded-lg border border-gray-300 shadow-sm object-cover"><span class="text-xs text-green-600 block mt-1">åœ–ç‰‡å·²è¼‰å…¥ï¼Œå°‡éš¨è«‹æ±‚ç™¼é€</span>`;
            }
            reader.readAsDataURL(file);
        }

        // --- AI è¡Œç¨‹è¦åŠƒ (ä¸»åŠŸèƒ½) ---
        window.handleAIPlan = async (type = 'travel') => {
            const loadingSpinner = document.getElementById('loading-spinner');
            const resultContainer = document.getElementById('itinerary-result');
            const resultText = document.getElementById('itinerary-text');
            loadingSpinner.classList.remove('hidden');
            resultContainer.classList.add('hidden'); 
            showView('view-itinerary');

            let systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„ AI æ—…éŠè¦åŠƒåŠ©ç†ã€‚è«‹æ ¹æ“šä½¿ç”¨è€…çš„éœ€æ±‚ï¼Œè¦åŠƒä¸€ä»½è©³ç´°çš„æ—…éŠè¡Œç¨‹ã€‚è«‹åˆ©ç”¨ Google Search åŠŸèƒ½æŸ¥æ‰¾æœ€æ–°çš„é–‹æ”¾è³‡æ–™(Open Data)å’Œæ—…éŠè³‡è¨Šã€‚å›å‚³ JSON æ ¼å¼ï¼š1. 'itineraryContent': Markdown æ ¼å¼è¡Œç¨‹æ–‡æœ¬ã€‚ 2. 'locations': åŒ…å« 'name', 'lat', 'lng', 'desc' çš„æ™¯é»åˆ—è¡¨ã€‚`;
            let userPrompt = "";
            let imageData = window.uploadedImage || null;

            if (type === 'travel') {
                const destination = document.getElementById('ai-destination').value;
                const days = document.getElementById('ai-days').value;
                const transport = document.getElementById('ai-transport').value;
                const accommodation = document.getElementById('ai-accommodation').checked ? "éœ€è¦ä½å®¿" : "ä¸éœ€è¦ä½å®¿";
                const custom = document.getElementById('ai-custom').value;
                userPrompt = `è¦åŠƒ ${days} å¤© ${destination} æ—…éŠã€‚äº¤é€š: ${transport}ã€‚ä½å®¿: ${accommodation}ã€‚éœ€æ±‚: ${custom}ã€‚è«‹æä¾›å…·é«”æ™¯é»åº§æ¨™ã€‚`;
                if (imageData) userPrompt += " åƒè€ƒé™„åœ–é¢¨æ ¼ã€‚";
            } else if (type === 'sports') {
                const sportType = document.getElementById('sport-type').value;
                const sportMode = document.getElementById('sport-mode').value;
                const sportLevel = document.getElementById('sport-level').value;
                systemPrompt += " ä½ æ˜¯æˆ¶å¤–é‹å‹•å°ˆå®¶ã€‚";
                userPrompt = `è¦åŠƒ ${sportMode} ${sportType} æŒ‘æˆ°è·¯ç·šï¼Œé›£åº¦ ${sportLevel}ã€‚åˆ—å‡ºè£œçµ¦é»ã€‚`;
            }

            try {
                const result = await callGeminiAPI(systemPrompt, userPrompt, imageData, true, true);
                window.currentItineraryText = result.itineraryContent;

                let html = convertMarkdownToHTML(result.itineraryContent);
                html += `
                    <div class="mt-6 flex flex-wrap gap-2 no-print border-t pt-4">
                        <button onclick="translateContent('itinerary-text', 'en')" class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg text-sm hover:bg-indigo-200 transition-colors flex items-center">
                            <i data-lucide="languages" class="w-4 h-4 mr-1"></i>Translate
                        </button>
                        <button onclick="generatePackingList()" class="bg-pink-100 text-pink-700 px-4 py-2 rounded-lg text-sm hover:bg-pink-200 transition-colors flex items-center">
                            <i data-lucide="list-checks" class="w-4 h-4 mr-1"></i>âœ¨ ç”Ÿæˆæ‰“åŒ…æ¸…å–®
                        </button>
                        <button onclick="recommendFood()" class="bg-orange-100 text-orange-700 px-4 py-2 rounded-lg text-sm hover:bg-orange-200 transition-colors flex items-center">
                            <i data-lucide="utensils" class="w-4 h-4 mr-1"></i>ğŸ½ï¸ å¿…è²·ä¼´æ‰‹ç¦®
                        </button>
                        <button onclick="recommendWeather()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg text-sm hover:bg-blue-200 transition-colors flex items-center">
                            <i data-lucide="cloud-sun" class="w-4 h-4 mr-1"></i>ğŸŒ¤ï¸ å¤©æ°£ç©¿è‘—å»ºè­°
                        </button>
                        <button onclick="playAudioGuideForContent('itinerary-text')" class="bg-purple-100 text-purple-700 px-4 py-2 rounded-lg text-sm hover:bg-purple-200 transition-colors flex items-center">
                            <i data-lucide="volume-2" class="w-4 h-4 mr-1"></i>èªéŸ³å°è¦½
                        </button>
                    </div>
                    <div id="packing-list-result" class="mt-4 hidden p-4 bg-pink-50 rounded-lg border border-pink-100"></div>
                    <div id="food-recommend-result" class="mt-4 hidden p-4 bg-orange-50 rounded-lg border border-orange-100"></div>
                    <div id="weather-recommend-result" class="mt-4 hidden p-4 bg-blue-50 rounded-lg border border-blue-100"></div>
                `;
                resultText.innerHTML = html;
                if (typeof lucide !== 'undefined') lucide.createIcons();

                if (result.locations && result.locations.length > 0) {
                    updateMapMarkers(result.locations);
                }
                resultContainer.classList.remove('hidden');

                if (type === 'travel' && window.currentUserId) {
                    const dest = document.getElementById('ai-destination').value;
                    await saveFrequentPlace(window.currentUserId, dest);
                }

            } catch (error) {
                resultText.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg border border-red-200">
                    <p class="font-bold flex items-center"><i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i>è¦åŠƒå¤±æ•—</p>
                    <p class="mt-2">${error.message}</p>
                    <button onclick="showModal('settings-modal')" class="mt-3 bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700">å‰å¾€è¨­å®šè¼¸å…¥ API Key</button>
                </div>`;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                resultContainer.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
                window.uploadedImage = null;
                document.getElementById('image-preview').innerHTML = '';
                document.getElementById('image-upload').value = ''; 
            }
        };

        // --- LLM Features ---
        window.generatePackingList = async () => {
            const container = document.getElementById('packing-list-result');
            container.classList.remove('hidden');
            container.innerHTML = '<div class="flex items-center text-pink-600"><i data-lucide="loader-2" class="animate-spin mr-2"></i> AI æ­£åœ¨ç‚ºæ‚¨æ•´ç†è¡Œæ...</div>';
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            const systemPrompt = "ä½ æ˜¯ä¸€å€‹è²¼å¿ƒçš„æ—…éŠç®¡å®¶ã€‚è«‹æ ¹æ“šè¡Œç¨‹åˆ—å‡ºå¿…å‚™çš„ã€Œæ‰“åŒ…æ¸…å–®ã€ã€‚åˆ†é¡ç‚ºï¼šè­‰ä»¶è²¡å‹™ã€è¡£ç‰©ã€é›»å­ã€ç›¥æ´—ã€è—¥å“ã€å…¶ä»–ã€‚ä½¿ç”¨ Markdown Checkboxã€‚";
            const userPrompt = `è«‹æ ¹æ“šæ­¤è¡Œç¨‹ç”Ÿæˆæ‰“åŒ…æ¸…å–®ï¼š\n${window.currentItineraryText}`;
            
            try {
                const result = await callGeminiAPI(systemPrompt, userPrompt);
                container.innerHTML = `<h3 class="font-bold text-pink-700 mb-2">ğŸ’ æ‚¨çš„å°ˆå±¬æ‰“åŒ…æ¸…å–®</h3>` + convertMarkdownToHTML(result.text);
            } catch (e) { container.innerHTML = `<p class="text-red-500">${e.message}</p>`; }
        };

        window.recommendFood = async () => { // å¯¦éš›ä¸Šæ˜¯ä¼´æ‰‹ç¦®
            const container = document.getElementById('food-recommend-result');
            container.classList.remove('hidden');
            container.innerHTML = '<div class="flex items-center text-orange-600"><i data-lucide="loader-2" class="animate-spin mr-2"></i> AI æ­£åœ¨æœå°‹ä¼´æ‰‹ç¦®...</div>';
            if (typeof lucide !== 'undefined') lucide.createIcons();

            const systemPrompt = "ä½ æ˜¯ä¸€å€‹è³¼ç‰©å°ˆå®¶ã€‚è«‹æ¨è–¦ 5 é …è©²æ—…éŠåœ°é»å¿…è²·çš„ã€Œç‰¹è‰²ä¼´æ‰‹ç¦®ã€æˆ–ã€Œåç”¢ã€ã€‚è«‹åŒ…å«ï¼šåç¨±ã€æ¨è–¦ç†ç”±ã€åƒè€ƒåƒ¹æ ¼ã€‚";
            const userPrompt = `è«‹æ ¹æ“šæ­¤è¡Œç¨‹åœ°é»æ¨è–¦ä¼´æ‰‹ç¦®ï¼š\n${window.currentItineraryText}`;

            try {
                const result = await callGeminiAPI(systemPrompt, userPrompt, null, true);
                container.innerHTML = `<h3 class="font-bold text-orange-700 mb-2">ğŸ å¿…è²·ä¼´æ‰‹ç¦®æ¨è–¦</h3>` + convertMarkdownToHTML(result.text);
            } catch (e) { container.innerHTML = `<p class="text-red-500">${e.message}</p>`; }
        };

        window.recommendWeather = async () => {
            const container = document.getElementById('weather-recommend-result');
            container.classList.remove('hidden');
            container.innerHTML = '<div class="flex items-center text-blue-600"><i data-lucide="loader-2" class="animate-spin mr-2"></i> AI æ­£åœ¨åˆ†æå¤©æ°£...</div>';
            if (typeof lucide !== 'undefined') lucide.createIcons();

            const systemPrompt = "ä½ æ˜¯ä¸€å€‹æ°£è±¡èˆ‡ç©¿æ­é¡§å•ã€‚è«‹æ ¹æ“šæ—…éŠåœ°é»èˆ‡å¯èƒ½çš„å­£ç¯€ï¼Œé æ¸¬å¤©æ°£ç‹€æ³ä¸¦çµ¦å‡ºå…·é«”çš„ã€Œç©¿è‘—å»ºè­°ã€ã€‚";
            const userPrompt = `è«‹æ ¹æ“šæ­¤è¡Œç¨‹çµ¦äºˆå¤©æ°£èˆ‡ç©¿æ­å»ºè­°ï¼š\n${window.currentItineraryText}`;

            try {
                const result = await callGeminiAPI(systemPrompt, userPrompt, null, true);
                container.innerHTML = `<h3 class="font-bold text-blue-700 mb-2">ğŸŒ¤ï¸ å¤©æ°£èˆ‡ç©¿è‘—æŒ‡å—</h3>` + convertMarkdownToHTML(result.text);
            } catch (e) { container.innerHTML = `<p class="text-red-500">${e.message}</p>`; }
        };

        window.translateContent = async (elementId, targetLang) => {
            const element = document.getElementById(elementId);
            if (!element.dataset.originalHtml) element.dataset.originalHtml = element.innerHTML;
            const btn = element.querySelector('button[onclick*="translateContent"]');
            if(btn) btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin mr-1"></i>Translating...';
            if (typeof lucide !== 'undefined') lucide.createIcons();

            try {
                const result = await callGeminiAPI("ä½ æ˜¯å°ˆæ¥­ç¿»è­¯ã€‚è«‹å°‡å…§å®¹ç¿»è­¯æˆè‹±æ–‡ï¼Œä¿ç•™ Markdownã€‚", `Translate:\n${element.innerText.substring(0, 3000)}`);
                let html = convertMarkdownToHTML(result.text);
                html += `<div class="mt-6 border-t pt-4"><button onclick="restoreContent('${elementId}')" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm">é‚„åŸåŸæ–‡</button></div>`;
                element.innerHTML = html;
            } catch (e) { showMessage("ç¿»è­¯å¤±æ•—", e.message); if(btn) btn.innerText = "Translate"; }
        };

        window.restoreContent = (id) => {
            const el = document.getElementById(id);
            if (el.dataset.originalHtml) el.innerHTML = el.dataset.originalHtml;
        };

        // --- Chatbot ---
        window.toggleAIChat = () => { document.getElementById('ai-chat-window').classList.toggle('hidden'); };
        window.handleAIChatSend = async () => {
            const input = document.getElementById('ai-chat-input');
            const body = document.getElementById('ai-chat-body');
            const text = input.value.trim();
            if (!text) return;
            body.innerHTML += `<div class="text-right mb-2"><span class="bg-blue-600 text-white px-3 py-2 rounded-lg inline-block text-sm">${text}</span></div>`;
            input.value = '';
            body.scrollTop = body.scrollHeight;
            
            const loadingId = 'chat-loading-' + Date.now();
            body.innerHTML += `<div id="${loadingId}" class="text-left mb-2"><span class="bg-gray-100 text-gray-500 px-3 py-2 rounded-lg text-sm">Thinking...</span></div>`;
            
            try {
                const context = window.currentItineraryText ? `[è¡Œç¨‹]:\n${window.currentItineraryText.substring(0, 5000)}` : "";
                const result = await callGeminiAPI("æ—…éŠå°å¹«æ‰‹ï¼Œè«‹æ ¹æ“šè¡Œç¨‹å›ç­”ã€‚", `${context}\nä½¿ç”¨è€…: ${text}`);
                document.getElementById(loadingId).remove();
                body.innerHTML += `<div class="text-left mb-2"><span class="bg-gray-200 text-gray-800 px-3 py-2 rounded-lg inline-block text-sm text-left">${convertMarkdownToHTML(result.text)}</span></div>`;
            } catch (e) {
                document.getElementById(loadingId).remove();
                body.innerHTML += `<div class="text-left mb-2"><span class="bg-red-100 text-red-600 px-3 py-2 rounded-lg text-sm">Error: ${e.message}</span></div>`;
            }
            body.scrollTop = body.scrollHeight;
        };

        // --- TTS ---
        function pcmToWav(pcmData, sampleRate) {
            const header = new ArrayBuffer(44);
            const d = new DataView(header);
            const dataLen = pcmData.length;
            d.setUint8(0, 0x52); d.setUint8(1, 0x49); d.setUint8(2, 0x46); d.setUint8(3, 0x46);
            d.setUint32(4, 36 + dataLen, true);
            d.setUint8(8, 0x57); d.setUint8(9, 0x41); d.setUint8(10, 0x56); d.setUint8(11, 0x45);
            d.setUint8(12, 0x66); d.setUint8(13, 0x6D); d.setUint8(14, 0x74); d.setUint8(15, 0x20);
            d.setUint32(16, 16, true); d.setUint16(20, 1, true); d.setUint16(22, 1, true);
            d.setUint32(24, sampleRate, true); d.setUint32(28, sampleRate * 2, true);
            d.setUint16(32, 2, true); d.setUint16(34, 16, true);
            d.setUint8(36, 0x64); d.setUint8(37, 0x61); d.setUint8(38, 0x74); d.setUint8(39, 0x61);
            d.setUint32(40, dataLen, true);
            return new Blob([header, pcmData], { type: 'audio/wav' });
        }

        window.playAudioGuideForContent = async (elementId) => {
            const element = document.getElementById(elementId);
            const text = element.innerText.substring(0, 300); 
            const btn = element.querySelector('button[onclick*="playAudioGuide"]');
            const originalText = btn ? btn.innerHTML : "èªéŸ³å°è¦½";
            
            try {
                if(btn) btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin mr-1"></i>Loading...';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                const base64Audio = await callGeminiAPI("", `è«‹ç”¨å°éŠå£å»æœ—è®€(100å­—)ï¼š\n${text}`, null, false, false, 'gemini-2.5-flash-preview-tts');
                
                const binStr = atob(base64Audio.data);
                const len = binStr.length;
                const arr = new Uint8Array(len);
                for (let i = 0; i < len; i++) arr[i] = binStr.charCodeAt(i);
                
                const blob = pcmToWav(arr, 24000);
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play();
                
                if(btn) btn.innerHTML = '<i data-lucide="volume-2" class="mr-1"></i>Playing...';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                audio.onended = () => { if(btn) btn.innerHTML = originalText; };
            } catch (e) {
                console.error(e);
                showMessage("èªéŸ³éŒ¯èª¤", e.message);
                if(btn) btn.innerHTML = originalText;
            }
        };

        // --- Helpers ---
        async function saveFrequentPlace(userId, place) {
            if (!userId || !place) return;
            const prefRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, "preferences");
            try {
                const docSnap = await getDoc(prefRef);
                let currentPlaces = docSnap.exists() ? docSnap.data().frequentPlaces || [] : [];
                if (!currentPlaces.includes(place)) {
                    currentPlaces.push(place);
                    if(currentPlaces.length > 5) currentPlaces = currentPlaces.slice(-5);
                    await setDoc(prefRef, { frequentPlaces: currentPlaces }, { merge: true });
                }
                fetchUserPreferences(userId);
            } catch (e) { console.error(e); }
        }

        function convertMarkdownToHTML(text) {
            if(!text) return "";
            return text
                .replace(/^### (.*$)/gim, '<h3 class="text-xl font-semibold mt-4 mb-2">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="text-2xl font-bold mt-6 mb-3 border-b pb-1">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="text-3xl font-extrabold mt-8 mb-4">$1</h1>')
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/^\* (.*$)/gim, '<li class="ml-4 list-disc">$1</li>')
                .replace(/- \[ \] (.*$)/gim, '<div class="flex items-center mt-1"><input type="checkbox" class="mr-2">$1</div>')
                .replace(/\n/gim, '<br>');
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            showView('view-home');
            document.querySelectorAll('#main-nav button').forEach(btn => btn.addEventListener('click', () => showView(btn.dataset.view)));
            document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal-container').id)));
            
            // Auto-show settings if no API key
            if (!getEffectiveApiKey()) {
                setTimeout(() => {
                    showModal('settings-modal');
                    // Add a welcoming prompt to the settings modal if it's auto-opened
                    const modalTitle = document.querySelector('#settings-modal h3');
                    if (modalTitle) modalTitle.textContent = "æ­¡è¿ï¼è«‹å…ˆè¨­å®š API Key";
                }, 600);
            }
        });
    </script>

    <!-- UI Structure -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i data-lucide="palmtree" class="text-blue-600"></i>
                <span class="text-xl font-bold text-gray-800">AI æ™ºæ…§æ—…éŠ</span>
            </div>
            <div id="main-nav" class="hidden md:flex items-center space-x-6">
                <button data-view="view-home" class="text-gray-600 hover:text-blue-600 flex items-center space-x-1"><i data-lucide="home" class="w-4 h-4"></i><span>é¦–é </span></button>
                <button data-view="view-explore" class="text-gray-600 hover:text-blue-600 flex items-center space-x-1"><i data-lucide="search" class="w-4 h-4"></i><span>æ¢ç´¢æ™¯é»</span></button>
                <button data-view="view-planner" class="text-gray-600 hover:text-blue-600 flex items-center space-x-1"><i data-lucide="bot" class="w-4 h-4"></i><span>AI è¦åŠƒ</span></button>
                <button data-view="view-sports" class="text-gray-600 hover:text-blue-600 flex items-center space-x-1"><i data-lucide="bike" class="w-4 h-4"></i><span>é‹å‹•æŒ‘æˆ°</span></button>
                <button data-view="view-my-trips" class="text-gray-600 hover:text-blue-600 flex items-center space-x-1"><i data-lucide="map" class="w-4 h-4"></i><span>æˆ‘çš„è¡Œç¨‹</span></button>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="showModal('settings-modal')" class="text-gray-600 hover:text-blue-600"><i data-lucide="settings" class="w-5 h-5"></i></button>
                <div id="auth-nav" class="flex items-center space-x-2">
                    <button onclick="showModal('login-modal')" class="text-sm text-gray-600">ç™»å…¥</button>
                    <button onclick="showModal('register-modal')" class="text-sm bg-blue-600 text-white px-4 py-2 rounded-full shadow hover:bg-blue-700">è¨»å†Š</button>
                </div>
                <div id="user-nav" class="hidden flex items-center space-x-3">
                    <span id="user-email-display" class="text-sm text-gray-500 hidden md:block"></span>
                    <button onclick="handleLogout()" class="text-gray-600 hover:text-blue-600"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-6">
        <div id="view-home" class="page-view">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white rounded-2xl shadow-xl p-8 md:p-16 text-center my-6">
                <h1 class="text-4xl md:text-5xl font-extrabold mb-4">æ¢ç´¢ä¸–ç•Œï¼ŒAI ç‚ºæ‚¨é ˜èˆª</h1>
                <p class="text-lg md:text-xl text-blue-100 mb-8">æ•´åˆå³æ™‚é–‹æ”¾è³‡æ–™ï¼Œå¾äº¤é€šã€ä½å®¿åˆ°è¡Œç¨‹ï¼Œä¸€éµæå®šã€‚</p>
            </div>
            <div id="quick-access" class="my-6 p-4 bg-blue-50 rounded-lg hidden flex flex-wrap items-center"></div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 my-8">
                <div class="bg-white p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition-shadow" onclick="showView('view-planner')">
                    <i data-lucide="bot" class="w-12 h-12 text-blue-600 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">AI è¡Œç¨‹è¦åŠƒ</h3>
                    <p class="text-gray-600 text-sm">è¼¸å…¥æ¢ä»¶ï¼ŒAI è‡ªå‹•ç”Ÿæˆå®Œç¾è¡Œç¨‹ã€‚</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition-shadow" onclick="showView('view-sports')">
                    <i data-lucide="bike" class="w-12 h-12 text-green-600 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">é‹å‹•æŒ‘æˆ°</h3>
                    <p class="text-gray-600 text-sm">å¾’æ­¥ã€è‡ªè¡Œè»Šç’°å³¶ï¼ŸAI å¹«æ‚¨è¦åŠƒè·¯ç·šã€‚</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition-shadow" onclick="showView('view-explore')">
                    <i data-lucide="flame" class="w-12 h-12 text-red-600 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">æ™¯é»ç†±åº¦</h3>
                    <p class="text-gray-600 text-sm">é¿é–‹äººæ½®ï¼ŒAI é æ¸¬æ™¯é»æ“æ“ æ™‚æ®µã€‚</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition-shadow" onclick="showView('view-my-trips')">
                    <i data-lucide="users" class="w-12 h-12 text-purple-600 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">è¡Œç¨‹å”ä½œ</h3>
                    <p class="text-gray-600 text-sm">é‚€è«‹å¥½å‹å…±åŒç·¨è¼¯è¡Œç¨‹ã€‚</p>
                </div>
            </div>

            <!-- Recommendations -->
            <h2 class="text-2xl font-bold mb-4">ç†±é–€æ¨è–¦è¡Œç¨‹</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer hover:scale-105 transition-transform">
                    <img src="https://placehold.co/600x400/3498db/ffffff?text=Taipei" alt="Taipei" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">3 Days</span>
                        <h4 class="text-lg font-semibold my-2">å°åŒ—ç¶“å…¸æ–‡åŒ–ä¹‹æ—…</h4>
                        <p class="text-sm text-gray-600 mb-3">æ•…å®®ã€101ã€ä¹ä»½è€è¡—...</p>
                        <button class="text-blue-600 text-sm hover:underline">æŸ¥çœ‹è©³æƒ…</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer hover:scale-105 transition-transform">
                    <img src="https://placehold.co/600x400/2ecc71/ffffff?text=Hualien" alt="Hualien" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">5 Days</span>
                        <h4 class="text-lg font-semibold my-2">èŠ±æ±ç¸±è°·è‡ªè¡Œè»Šæ…¢éŠ</h4>
                        <p class="text-sm text-gray-600 mb-3">ä¼¯æœ—å¤§é“ã€å¤ªé­¯é–£ã€ä¸ƒæ˜Ÿæ½­...</p>
                        <button class="text-blue-600 text-sm hover:underline">æŸ¥çœ‹è©³æƒ…</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer hover:scale-105 transition-transform">
                    <img src="https://placehold.co/600x400/e74c3c/ffffff?text=Tainan" alt="Tainan" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full">2 Days</span>
                        <h4 class="text-lg font-semibold my-2">å°å—ç¾é£Ÿåƒåˆ°é£½</h4>
                        <p class="text-sm text-gray-600 mb-3">åœ‹è¯è¡—ã€å®‰å¹³å¤å ¡ã€ç‰›è‚‰æ¹¯...</p>
                        <button class="text-blue-600 text-sm hover:underline">æŸ¥çœ‹è©³æƒ…</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- view-explore -->
        <div id="view-explore" class="page-view">
            <h2 class="text-3xl font-bold mb-6">æ¢ç´¢æ™¯é»</h2>
            <div class="flex flex-wrap gap-4 mb-6 p-4 bg-white rounded-lg shadow">
                <select class="border rounded-lg px-4 py-2"><option>æ‰€æœ‰åœ°å€</option><option>å°åŒ—</option><option>å°ä¸­</option><option>èŠ±è“®</option></select>
                <select class="border rounded-lg px-4 py-2"><option>æ‰€æœ‰é¡å‹</option><option>è‡ªç„¶æ™¯è§€</option><option>äººæ–‡æ­·å²</option><option>ç¾é£Ÿ</option></select>
                <button class="bg-blue-600 text-white px-6 py-2 rounded-lg">ç¯©é¸</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <img src="https://placehold.co/600x400/9b59b6/ffffff?text=Spot+A" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h4 class="text-lg font-semibold mb-1">è±¡å±±æ­¥é“ (Xiangshan)</h4>
                        <p class="text-sm text-gray-600 mb-2">æœ€ä½³çš„å°åŒ— 101 è§€è³é»ã€‚</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-red-500 h-2.5 rounded-full" style="width: 80%"></div></div>
                        <p class="text-xs text-red-600 text-center mt-1">ç›®å‰äººæ½®æ“æ“ </p>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <img src="https://placehold.co/600x400/f1c40f/ffffff?text=Spot+B" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h4 class="text-lg font-semibold mb-1">å¯©è¨ˆæ–°æ‘</h4>
                        <p class="text-sm text-gray-600 mb-2">æ–‡é’å¿…è¨ªï¼Œå……æ»¿ç‰¹è‰²å°åº—ã€‚</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width: 30%"></div></div>
                        <p class="text-xs text-green-600 text-center mt-1">ç›®å‰èˆ’é©</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- view-planner -->
        <div id="view-planner" class="page-view">
            <h2 class="text-3xl font-bold mb-6">AI è¡Œç¨‹è¦åŠƒ</h2>
            <div class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-xl">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç›®çš„åœ°</label>
                        <select id="ai-destination" class="w-full border border-gray-300 px-4 py-2 rounded-lg">
                            <option value="å°åŒ—">å°åŒ—</option>
                            <option value="å°ä¸­">å°ä¸­</option>
                            <option value="å°å—">å°å—</option>
                            <option value="é«˜é›„">é«˜é›„</option>
                            <option value="èŠ±è“®">èŠ±è“®</option>
                            <option value="å°æ±">å°æ±</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ—…éŠå¤©æ•¸</label>
                        <input type="number" id="ai-days" value="3" class="w-full border px-4 py-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä¸»è¦äº¤é€š</label>
                        <select id="ai-transport" class="w-full border px-4 py-2 rounded-lg">
                            <option value="å¤§çœ¾é‹è¼¸">å¤§çœ¾é‹è¼¸</option>
                            <option value="è‡ªè¡Œé–‹è»Š">è‡ªè¡Œé–‹è»Š</option>
                            <option value="æ©Ÿè»Š">æ©Ÿè»Š</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä¸Šå‚³åœ–ç‰‡ (é¸å¡«)</label>
                        <input type="file" id="image-upload" accept="image/*" onchange="handleImageUpload(event)" class="w-full border p-2 rounded-lg">
                        <div id="image-preview" class="mt-2"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å…¶ä»–éœ€æ±‚</label>
                        <textarea id="ai-custom" rows="2" class="w-full border px-4 py-2 rounded-lg" placeholder="e.g. è¦ªå­, æ”å½±, ç¾é£Ÿ"></textarea>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="ai-accommodation" checked class="h-4 w-4">
                        <label class="ml-2 text-sm text-gray-900">éœ€è¦æ¨è–¦ä½å®¿</label>
                    </div>
                    <button onclick="handleAIPlan('travel')" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 flex justify-center items-center space-x-2">
                        <i data-lucide="wand-2"></i><span>é–‹å§‹è¦åŠƒ</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- view-itinerary (Result) -->
        <div id="view-itinerary" class="page-view">
            <h2 class="text-3xl font-bold mb-4">è¡Œç¨‹è¦åŠƒçµæœ</h2>
            <div id="loading-spinner" class="hidden text-center my-12">
                <i data-lucide="loader-2" class="w-16 h-16 text-blue-600 animate-spin mx-auto"></i>
                <p class="text-lg text-gray-600 mt-4">AI æ­£åœ¨æœå°‹é–‹æ”¾è³‡æ–™ä¸¦è¨ˆç®—è·¯ç·š...</p>
            </div>
            
            <div id="itinerary-result" class="bg-white p-6 rounded-2xl shadow-xl hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="h-96 lg:h-auto">
                         <div id="map" class="shadow-inner border"></div>
                         <p class="text-xs text-gray-500 mt-2 text-center">*åœ°åœ–æ¨™è¨˜ç”± AI æ ¹æ“šåœ°é»åç¨±è‡ªå‹•ç”Ÿæˆåº§æ¨™</p>
                    </div>
                    <div class="prose prose-sm max-w-none overflow-y-auto max-h-[600px] pr-2" id="itinerary-text"></div>
                </div>
            </div>
        </div>

        <!-- view-sports -->
        <div id="view-sports" class="page-view">
            <h2 class="text-3xl font-bold mb-6">é‹å‹•æŒ‘æˆ°è¦åŠƒ</h2>
            <div class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-xl">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æŒ‘æˆ°é¡å‹</label>
                        <select id="sport-type" class="w-full border border-gray-300 px-4 py-2 rounded-lg">
                            <option value="ç’°å³¶ (å°ç£æœ¬å³¶)">ç’°å³¶</option>
                            <option value="é•·ç¨‹ç¸±èµ°">é•·ç¨‹ç¸±èµ°</option>
                            <option value="è‡ªè¨‚è·¯ç·š">è‡ªè¨‚è·¯ç·š</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æŒ‘æˆ°æ–¹å¼</label>
                        <select id="sport-mode" class="w-full border border-gray-300 px-4 py-2 rounded-lg">
                            <option value="è‡ªè¡Œè»Š">è‡ªè¡Œè»Š</option>
                            <option value="å¾’æ­¥">å¾’æ­¥</option>
                            <option value="æ©Ÿè»Š">æ©Ÿè»Š</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é›£åº¦ç­‰ç´š</label>
                        <select id="sport-level" class="w-full border border-gray-300 px-4 py-2 rounded-lg">
                            <option value="ä¼‘é–’">ä¼‘é–’</option>
                            <option value="æŒ‘æˆ°">æŒ‘æˆ°</option>
                            <option value="æ¥µé™">æ¥µé™</option>
                        </select>
                    </div>
                    <button onclick="handleAIPlan('sports')" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg text-lg font-semibold shadow-lg hover:bg-green-700 transition-colors flex items-center justify-center space-x-2">
                        <i data-lucide="route"></i>
                        <span>è¦åŠƒæŒ‘æˆ°è·¯ç·š</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- view-my-trips -->
        <div id="view-my-trips" class="page-view">
            <h2 class="text-3xl font-bold mb-6">æˆ‘çš„è¡Œç¨‹</h2>
            <p class="text-gray-600">é€™è£¡æ˜¯æ‚¨å„²å­˜çš„è¡Œç¨‹ã€‚</p>
            <div class="mt-6 bg-white p-6 rounded-lg shadow-md flex justify-between items-center">
                <div>
                    <h4 class="text-lg font-semibold">æˆ‘çš„ 3 æ—¥å°åŒ—ä¹‹æ—… (ç¯„ä¾‹)</h4>
                    <p class="text-sm text-gray-500">å·²å„²å­˜ | å”ä½œè€…ï¼šæ‚¨ã€å¼µä¸‰</p>
                </div>
                <div>
                    <button class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg text-sm">æŸ¥çœ‹</button>
                    <button class="text-red-500 hover:text-red-700 ml-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>

    </main>

    <!-- Chatbot -->
    <div class="fixed bottom-4 right-4 z-40">
        <div id="ai-chat-window" class="hidden w-80 h-96 bg-white rounded-2xl shadow-2xl flex flex-col border border-gray-200 modal-content">
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center">
                <h4 class="font-semibold">AI è¡Œç¨‹åŠ©ç†</h4>
                <button onclick="toggleAIChat()" class="text-blue-100 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="ai-chat-body" class="flex-1 p-4 space-y-4 overflow-y-auto bg-gray-50">
                <div class="text-left"><span class="bg-white border text-gray-800 px-4 py-2 rounded-lg inline-block shadow-sm">æ‚¨å¥½ï¼é—œæ–¼æ‚¨çš„è¡Œç¨‹æœ‰ä»€éº¼æƒ³å•çš„å—ï¼Ÿ</span></div>
            </div>
            <div class="p-2 border-t bg-white flex">
                <input id="ai-chat-input" type="text" placeholder="ä¾‹å¦‚: æ™šé¤æ¨è–¦åƒä»€éº¼?" class="w-full px-3 py-2 border rounded-lg">
                <button onclick="handleAIChatSend()" class="bg-blue-600 text-white p-2 rounded-lg ml-2"><i data-lucide="send" class="w-5 h-5"></i></button>
            </div>
        </div>
        <button onclick="toggleAIChat()" class="bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center hover:scale-110 transition-transform"><i data-lucide="message-circle" class="w-7 h-7"></i></button>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-container hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full relative">
            <button class="modal-close absolute top-4 right-4 text-gray-400"><i data-lucide="x"></i></button>
            <h3 class="text-xl font-bold mb-4">è¨­å®š</h3>
            <label class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
            <input type="password" id="api-key-input" placeholder="è²¼ä¸Šæ‚¨çš„ API Key" class="w-full border mb-2 p-2 rounded text-sm">
            <div class="flex justify-between items-center mb-4">
                <span id="api-key-status" class="text-xs text-gray-500">æœªè¨­å®š</span>
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-blue-600 hover:underline">å–å¾— API Key</a>
            </div>
            <button onclick="saveApiKey()" class="w-full bg-gray-800 text-white py-2 rounded">å„²å­˜è¨­å®š</button>
        </div>
    </div>

    <!-- Modals: Login -->
    <div id="login-modal" class="modal-container hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-white p-8 rounded-2xl max-w-sm w-full relative">
            <button class="modal-close absolute top-4 right-4"><i data-lucide="x"></i></button>
            <h3 class="text-2xl font-bold mb-4">ç™»å…¥</h3>
            <input id="login-email" placeholder="Email" class="w-full border mb-3 p-2 rounded">
            <input id="login-password" type="password" placeholder="Password" class="w-full border mb-4 p-2 rounded">
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-2 rounded">ç™»å…¥</button>
        </div>
    </div>

    <!-- Modals: Register -->
    <div id="register-modal" class="modal-container hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-white p-8 rounded-2xl max-w-sm w-full relative">
            <button class="modal-close absolute top-4 right-4"><i data-lucide="x"></i></button>
            <h3 class="text-2xl font-bold mb-4">è¨»å†Š</h3>
            <input id="reg-name" placeholder="Name" class="w-full border mb-3 p-2 rounded">
            <input id="reg-email" placeholder="Email" class="w-full border mb-3 p-2 rounded">
            <input id="reg-password" type="password" placeholder="Password" class="w-full border mb-4 p-2 rounded">
            <button onclick="handleRegister()" class="w-full bg-blue-600 text-white py-2 rounded">è¨»å†Š</button>
        </div>
    </div>

    <!-- Modals: Message -->
    <div id="message-modal" class="modal-container hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-white p-8 rounded-2xl max-w-sm w-full text-center">
            <h3 id="message-title" class="text-xl font-bold mb-4"></h3>
            <p id="message-body" class="mb-6"></p>
            <button onclick="closeModal('message-modal')" class="bg-blue-600 text-white px-6 py-2 rounded">ç¢ºå®š</button>
        </div>
    </div>

</body>
</html>
